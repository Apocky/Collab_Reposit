<html>
<head>
<title>index.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #6aab73;}
.s3 { color: #cf8e6d;}
.s4 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
index.js</font>
</center></td></tr></table>
<pre><span class="s0">// HALO Oracle Serverless Lambda handler</span>
<span class="s0">// This Lambda function provides two API methods via API Gateway:</span>
<span class="s0">// - GET  /readings : Returns all reading items from DynamoDB.</span>
<span class="s0">// - POST /readings : Stores a new reading item in DynamoDB.</span>

<span class="s0">// The function uses the AWS SDK v3 for DynamoDB with the DocumentClient</span>
<span class="s0">// to handle marshalling between native JavaScript types and DynamoDB item</span>
<span class="s0">// structures automatically. The target DynamoDB table name can be</span>
<span class="s0">// configured via the TABLE_NAME environment variable; otherwise it</span>
<span class="s0">// defaults to &quot;HaloReadings&quot;.</span>

<span class="s1">const { DynamoDBClient } = require(</span><span class="s2">&quot;@aws-sdk/client-dynamodb&quot;</span><span class="s1">);</span>
<span class="s1">const {</span>
  <span class="s1">DynamoDBDocumentClient,</span>
  <span class="s1">ScanCommand,</span>
  <span class="s1">PutCommand,</span>
<span class="s1">} = require(</span><span class="s2">&quot;@aws-sdk/lib-dynamodb&quot;</span><span class="s1">);</span>

<span class="s0">// Create lowâ€‘level and Document clients. The region and credentials</span>
<span class="s0">// are resolved automatically from the Lambda execution environment.</span>
<span class="s1">const ddbClient = </span><span class="s3">new </span><span class="s1">DynamoDBClient({});</span>
<span class="s1">const ddbDocClient = DynamoDBDocumentClient.from(ddbClient);</span>

<span class="s1">exports.handler = async (event) =&gt; {</span>
  <span class="s1">const tableName = process.env.TABLE_NAME || </span><span class="s2">&quot;HaloReadings&quot;</span><span class="s1">;</span>

  <span class="s3">try </span><span class="s1">{</span>
    <span class="s0">// Inspect the HTTP method from the event (when invoked via API Gateway)</span>
    <span class="s1">const method = (event.httpMethod || event.method || </span><span class="s2">&quot;GET&quot;</span><span class="s1">).toUpperCase();</span>

    <span class="s0">// Handle GET requests to list all readings</span>
    <span class="s3">if </span><span class="s1">(method === </span><span class="s2">&quot;GET&quot;</span><span class="s1">) {</span>
      <span class="s1">const data = await ddbDocClient.send(</span>
        <span class="s3">new </span><span class="s1">ScanCommand({ TableName: tableName })</span>
      <span class="s1">);</span>
      <span class="s3">return </span><span class="s1">{</span>
        <span class="s1">statusCode: </span><span class="s4">200</span><span class="s1">,</span>
        <span class="s1">headers: { </span><span class="s2">&quot;Content-Type&quot;</span><span class="s1">: </span><span class="s2">&quot;application/json&quot; </span><span class="s1">},</span>
        <span class="s1">body: JSON.stringify(data.Items || []),</span>
      <span class="s1">};</span>
    <span class="s1">}</span>

    <span class="s0">// Handle POST requests to create a new reading entry</span>
    <span class="s3">if </span><span class="s1">(method === </span><span class="s2">&quot;POST&quot;</span><span class="s1">) {</span>
      <span class="s0">// Parse the JSON body from the request</span>
      <span class="s1">let item;</span>
      <span class="s3">try </span><span class="s1">{</span>
        <span class="s1">item = JSON.parse(event.body || </span><span class="s2">&quot;{}&quot;</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s3">catch </span><span class="s1">(parseErr) {</span>
        <span class="s3">return </span><span class="s1">{</span>
          <span class="s1">statusCode: </span><span class="s4">400</span><span class="s1">,</span>
          <span class="s1">headers: { </span><span class="s2">&quot;Content-Type&quot;</span><span class="s1">: </span><span class="s2">&quot;application/json&quot; </span><span class="s1">},</span>
          <span class="s1">body: JSON.stringify({ message: </span><span class="s2">&quot;Invalid JSON payload&quot; </span><span class="s1">}),</span>
        <span class="s1">};</span>
      <span class="s1">}</span>

      <span class="s0">// Write the item to DynamoDB</span>
      <span class="s1">await ddbDocClient.send(</span>
        <span class="s3">new </span><span class="s1">PutCommand({ TableName: tableName, Item: item })</span>
      <span class="s1">);</span>
      <span class="s3">return </span><span class="s1">{</span>
        <span class="s1">statusCode: </span><span class="s4">201</span><span class="s1">,</span>
        <span class="s1">headers: { </span><span class="s2">&quot;Content-Type&quot;</span><span class="s1">: </span><span class="s2">&quot;application/json&quot; </span><span class="s1">},</span>
        <span class="s1">body: JSON.stringify({ message: </span><span class="s2">&quot;Reading stored&quot;</span><span class="s1">, item }),</span>
      <span class="s1">};</span>
    <span class="s1">}</span>

    <span class="s0">// Method not allowed</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s1">statusCode: </span><span class="s4">405</span><span class="s1">,</span>
      <span class="s1">headers: { </span><span class="s2">&quot;Content-Type&quot;</span><span class="s1">: </span><span class="s2">&quot;application/json&quot; </span><span class="s1">},</span>
      <span class="s1">body: JSON.stringify({ message: </span><span class="s2">&quot;Method not allowed&quot; </span><span class="s1">}),</span>
    <span class="s1">};</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">(err) {</span>
    <span class="s1">console.error(</span><span class="s2">&quot;Error handling request&quot;</span><span class="s1">, err);</span>
    <span class="s3">return </span><span class="s1">{</span>
      <span class="s1">statusCode: </span><span class="s4">500</span><span class="s1">,</span>
      <span class="s1">headers: { </span><span class="s2">&quot;Content-Type&quot;</span><span class="s1">: </span><span class="s2">&quot;application/json&quot; </span><span class="s1">},</span>
      <span class="s1">body: JSON.stringify({ message: err.message || </span><span class="s2">&quot;Internal server error&quot; </span><span class="s1">}),</span>
    <span class="s1">};</span>
  <span class="s1">}</span>
<span class="s1">};</span>
</pre>
</body>
</html>